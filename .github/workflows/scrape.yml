name: scraper
run-name: ATscraper
on: 
  schedule:
    # every 3am
    - cron: "0 3 * * *"
  push:
    branches: [main]
    # add automated notebooks
    paths:
      - 2025-03-27-github-graphql.ipynb
      - 2025-03-27-thingiverse.ipynb
      - 2025-02-24-ravelry.ipynb
      - pixi.toml
      - pixi.lock
      - .github/workflows/*
  pull_request:
    branches: ['*']
    paths:
      - 2025-03-27-github-graphql.ipynb
      - 2025-03-27-thingiverse.ipynb
      - 2025-02-24-ravelry.ipynb
      - pixi.toml
      - pixi.lock
      - .github/workflows/*
concurrency:
      group: "${{ github.workflow }}-${{ github.sha }}" 
      cancel-in-progress: false

permissions:
  contents: write
env:
  GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
jobs:
  previous: 
    runs-on: ubuntu-latest
    environment: scraper
    steps:
    - name: Retrieve Previous Workflow ID
      uses: actions/github-script@v6
      with:
        script: |
          const { data: workflows } = await github.actions.listWorkflowRuns({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: context.workflow,
            status: 'success'
          });
          if (workflows.length > 0) {
            core.setOutput('run_id', workflows[0].id);
          } else {
            core.info('No successful workflows found.');
          }

  github:
    runs-on: ubuntu-latest
    needs: previous
    environment: scraper
    steps:
    - uses: actions/checkout@v4    
    - uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: data-github
        path: data/github
        run-id: ${{ steps.previous.outputs.run_id }}
    - uses: prefix-dev/setup-pixi@v0.8.3
      with:
        pixi-version: v0.41.4
        cache: true
        cache-key: scraper
    - run: pixi run scrape-github
    - uses: actions/upload-artifact@v4
      with:
        name: data-github
        path: data/github
    - uses: actions/upload-artifact@v4
      with:
        name: scrape-github-${{ github.run_number }}
        path: |
          2025-03-27-github-graphql.ipynb
          reports/2025-03-27-github-graphql.html
  ravelry:
    runs-on: ubuntu-latest
    needs: previous
    environment: scraper
    steps:
    - uses: actions/checkout@v4    
    - uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: data-ravelry
        path: data/ravelry
        run-id: ${{ steps.previous.outputs.run_id }}
    - uses: prefix-dev/setup-pixi@v0.8.3
      with:
        pixi-version: v0.41.4
        cache: true
        cache-key: scraper
    - run: pixi run scrape-ravelry
      env:
        RAVELRY_USERNAME: ${{secrets.RAVELRY_USERNAME}}
        RAVELRY_PASSWORD: ${{secrets.RAVELRY_PASSWORD}}
    - uses: actions/upload-artifact@v4
      with:
        name: data-ravelry
        path: data/ravelry              
    - uses: actions/upload-artifact@v4
      with:
        name: scrape-ravelry-${{ github.run_number }}
        path: |
          2025-02-24-ravelry.ipynb
          reports/2025-02-24-ravelry.html
    
  thingiverse:
    runs-on: ubuntu-latest
    needs: previous
    environment: scraper
    steps:
    - uses: actions/checkout@v4    
    - uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: data-thingiverse
        path: data/thingiverse
        run-id: ${{ steps.previous.outputs.run_id }}
    - uses: prefix-dev/setup-pixi@v0.8.3
      with:
        pixi-version: v0.41.4
        cache: true
        cache-key: scraper
    - run: pixi run scrape-thingiverse
      env:
        THINGIVERSE_ACCESS_TOKEN: ${{secrets.THINGIVERSE_ACCESS_TOKEN}}
    - uses: actions/upload-artifact@v4
      with:
        name: data-thingiverse
        path: data/thingiverse
    - uses: actions/upload-artifact@v4
      with:
        name: scrape-thingiverse-${{ github.run_number }}
        path: |
          2025-03-27-thingiverse.ipynb
          reports/2025-03-27-thingiverse.html

  
  aggregate:
    runs-on: ubuntu-latest
    environment: scraper
    continue-on-error: true
    needs: [github, thingiverse, ravelry]
    steps:
    - uses: actions/checkout@v4    
    - uses: prefix-dev/setup-pixi@v0.8.3
      with:
        pixi-version: v0.41.4
        cache: true
        # this should use hashfiles
        cache-key: scraper
    - uses: actions/download-artifact@v4
      with:
        name: data-github
        path: data/github
    - uses: actions/download-artifact@v4
      with:
        name: data-ravelry
        path: data/ravelry
    - uses: actions/download-artifact@v4
      with:
        name: data-thingiverse
        path: data/thingiverse
    - run: ls -lathr
    - run: pixi run scrape-aggregate
    - uses: actions/upload-artifact@v4
      with:
        name: aggregate-${{ github.run_number }}
        path: |
          at.json.gz

  search:
    runs-on: ubuntu-latest
    environment: scraper
    needs: aggregate
    steps:
    - uses: actions/checkout@v4    
    - uses: prefix-dev/setup-pixi@v0.8.3
      with:
        pixi-version: v0.41.4
        cache: true
        cache-key: scraper
    - uses: actions/download-artifact@v4
      with:
        name: aggregate-${{ github.run_number }}
    - run: pixi run search
    - uses: actions/upload-artifact@v4
      with:
        name: scrape-thingiverse-${{ github.run_number }}
        path: |
          2025-03-27-thingiverse.ipynb
          reports/2025-03-27-thingiverse.html
    
  site:
    uses: a11yhood/site-settings/.github/workflows/jekyll.yaml@main
    needs: search
    secrets: 
      personal_access_token: ${{ secrets.token }}